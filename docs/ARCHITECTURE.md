# AI-Tilda: Архитектура и Flow

## Общая схема работы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              AI-TILDA v2.0                                   │
│                     Генератор лендингов на основе AJTBD                      │
└─────────────────────────────────────────────────────────────────────────────┘

                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ЭТАП 1: ИНТЕРВЬЮ                                     │
│                        (Interviewer Agent)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Пользователь                    API                      LLM              │
│       │                            │                        │               │
│       │  "Расскажи о продукте"     │                        │               │
│       │ ─────────────────────────► │                        │               │
│       │                            │  POST /api/interview   │               │
│       │                            │ ──────────────────────►│               │
│       │                            │                        │               │
│       │                            │  {stateUpdates,        │               │
│       │                            │   nextMessage,         │               │
│       │                            │   isComplete}          │               │
│       │                            │ ◄──────────────────────│               │
│       │   Следующий вопрос         │                        │               │
│       │ ◄───────────────────────── │                        │               │
│       │                            │                        │               │
│       │        ... цикл пока isComplete !== true ...        │               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ isComplete: true
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ЭТАП 2: ГЕНЕРАЦИЯ                                    │
│                        (Generator Agent)                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Frontend                        API                      LLM              │
│       │                            │                        │               │
│       │   AjtbdState (10 полей)    │                        │               │
│       │ ─────────────────────────► │                        │               │
│       │                            │  POST /api/generate    │               │
│       │                            │ ──────────────────────►│               │
│       │                            │                        │               │
│       │                            │  LandingPageData       │               │
│       │                            │  {settings, blocks[]}  │               │
│       │                            │ ◄──────────────────────│               │
│       │   JSON лендинга            │                        │               │
│       │ ◄───────────────────────── │                        │               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      ЭТАП 3: ПРЕВЬЮ + РЕДАКТИРОВАНИЕ                         │
│                          (Editor Agent)                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Пользователь                    API                      LLM              │
│       │                            │                        │               │
│       │  "Измени заголовок на..."  │                        │               │
│       │ ─────────────────────────► │                        │               │
│       │                            │  POST /api/chat        │               │
│       │                            │  {editRequest,         │               │
│       │                            │   currentSiteJson}     │               │
│       │                            │ ──────────────────────►│               │
│       │                            │                        │               │
│       │                            │  Updated JSON          │               │
│       │                            │ ◄──────────────────────│               │
│       │   Обновлённый лендинг      │                        │               │
│       │ ◄───────────────────────── │                        │               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Детали каждого этапа

### ЭТАП 1: Интервью (Interviewer Agent)

**Файл:** `src/lib/agents/interviewer.ts`
**API:** `POST /api/interview`

**Входные данные:**
```json
{
  "state": { /* AjtbdState - текущее состояние */ },
  "userMessage": "Ответ пользователя",
  "conversationHistory": "История диалога"
}
```

**AJTBD State (10 полей для заполнения):**
| Поле | Описание | Приоритет |
|------|----------|-----------|
| `productDescription` | Описание продукта/услуги | 1 (критическое) |
| `targetAudience` | Целевая аудитория | 2 (критическое) |
| `pointA` | Точка А — текущая проблема | 3 (критическое) |
| `pointB` | Точка Б — желаемый результат | 4 (критическое) |
| `coreJob` | Core Job — основная работа продукта | 5 |
| `valueProposition` | Ценностное предложение | 6 (критическое) |
| `trigger` | Триггер поиска решения | 7 |
| `alternatives` | Альтернативы/конкуренты | 8 |
| `barriers` | Барьеры к покупке | 9 |
| `bigJob` | Big Job — большая цель клиента | 10 |

**Системный промпт Interviewer:**
```
Ты — ИИ-маркетолог и интервьюер. Твоя задача — через естественный
диалог собрать информацию о продукте пользователя по методологии AJTBD.

**Твоя роль:**
- Веди беседу как дружелюбный эксперт, не как анкета
- Задавай открытые вопросы, слушай внимательно
- Периодически подтверждай понимание: "Правильно ли я понял, что..."
- Извлекай AJTBD-сущности из ответов пользователя

**Правила:**
1. Один ответ пользователя может заполнить несколько полей
2. Задавай по одному вопросу за раз
3. Вопросы должны быть естественными, без терминов AJTBD
4. После 3-4 обменов делай краткое саммари понятого
5. Когда критические поля заполнены, сообщи что готов генерировать
```

**Выходные данные:**
```json
{
  "stateUpdates": { "productDescription": "...", "targetAudience": "..." },
  "nextMessage": "Следующий вопрос ассистента",
  "isComplete": false
}
```

**Логика завершения:**
- `isComplete: true` когда заполнены все критические поля:
  - productDescription
  - targetAudience
  - pointA
  - pointB
  - valueProposition

---

### ЭТАП 2: Генерация (Generator Agent)

**Файл:** `src/lib/agents/generator.ts`
**API:** `POST /api/generate`

**Входные данные:**
```json
{
  "state": { /* Полный AjtbdState */ }
}
```

**Системный промпт Generator:**
```
Ты — UX-архитектор и копирайтер, эксперт по созданию продающих
лендингов по методологии AJTBD.

**Структура лендинга (6 блоков):**

1. hero — Главный экран
   content: { "title", "subtitle", "ctaText" }

2. features — Результаты / Точка Б
   content: { "title", "items": [{ "icon", "title", "description" }] }
   3-4 пункта

3. problem — Проблема / Точка А
   content: { "title", "description" }

4. how_it_works — Как это работает
   content: { "title", "steps": [{ "title", "description" }] }
   Ровно 3 шага

5. competitors — Почему мы / vs альтернативы
   content: { "title", "items": [{ "title", "description" }] }
   3-4 пункта

6. cta — Призыв к действию
   content: { "title", "description", "ctaText" }

**Формат ответа:**
{
  "settings": { "theme": "light", "accentColor": "#HEX", "mood": "friendly" },
  "blocks": [
    { "id": "hero-1", "type": "hero", "content": { ... } },
    ...
  ]
}
```

**Выходные данные:**
```json
{
  "settings": {
    "theme": "light",
    "accentColor": "#4A90E2",
    "mood": "friendly"
  },
  "blocks": [
    { "id": "hero-1", "type": "hero", "content": { ... } },
    { "id": "features-1", "type": "features", "content": { ... } },
    { "id": "problem-1", "type": "problem", "content": { ... } },
    { "id": "how_it_works-1", "type": "how_it_works", "content": { ... } },
    { "id": "competitors-1", "type": "competitors", "content": { ... } },
    { "id": "cta-1", "type": "cta", "content": { ... } }
  ]
}
```

---

### ЭТАП 3: Редактирование (Editor Agent)

**Файл:** `src/lib/agents/editor.ts`
**API:** `POST /api/chat`

**Входные данные:**
```json
{
  "editRequest": "Измени заголовок на...",
  "currentSiteJson": { /* Текущий LandingPageData */ }
}
```

**Системный промпт Editor:**
```
Ты — ИИ-ассистент, который помогает редактировать лендинг.

**Структура JSON сайта:**
{
  "settings": { "theme": "light", "accentColor": "#HEX", "mood": "..." },
  "blocks": [
    { "id": "hero-1", "type": "hero", "content": { ... } },
    ...
  ]
}

**Правила:**
- blocks — это МАССИВ объектов, сохраняй эту структуру
- Меняй только то, что просит пользователь
- Сохраняй ВСЕ блоки и их поля без изменений, кроме запрошенных
- Верни полный JSON сайта с внесённым изменением
```

**Выходные данные:**
```json
{
  "settings": { ... },
  "blocks": [ ... ]  // Обновлённые блоки
}
```

---

## Стейт-машина фронтенда

```
┌──────────────┐     isComplete: true     ┌──────────────┐
│   interview  │ ───────────────────────► │  generating  │
└──────────────┘                          └──────────────┘
       ▲                                         │
       │                                         │ Успех
       │ Ошибка                                  ▼
       │                                  ┌──────────────┐
       └────────────────────────────────  │   preview    │
                                          └──────────────┘
                                                 │
                                                 │ Пользователь пишет
                                                 ▼
                                          ┌──────────────┐
                                          │   editing    │◄──┐
                                          └──────────────┘   │
                                                 │           │
                                                 └───────────┘
                                              Новые правки
```

**Файл:** `src/hooks/useAppState.ts`

---

## Файловая структура агентов

```
src/lib/
├── agents/
│   ├── model.ts          # Вызов LLM (OpenRouter API)
│   ├── interviewer.ts    # Interviewer Agent
│   ├── generator.ts      # Generator Agent
│   └── editor.ts         # Editor Agent
├── prompts.ts            # Системные промпты (ANALYZER, GENERATOR, EDITOR)
└── schemas.ts            # Zod-схемы (не используются в v2)

src/app/api/
├── interview/route.ts    # POST /api/interview
├── generate/route.ts     # POST /api/generate
└── chat/route.ts         # POST /api/chat (редактирование)
```

---

## Технический стек

| Компонент | Технология |
|-----------|------------|
| Frontend | Next.js 15, React, TypeScript |
| Стили | Tailwind CSS v4 |
| LLM | OpenRouter API (claude-3.5-haiku) |
| Деплой | Vercel |
| Репозиторий | GitHub (goleynovv/AI-TILDA) |
